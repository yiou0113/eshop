<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>購物車</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/resources/css/style.css}" />

<style>
body {
	display: flex;
	justify-content: center; /* 水平置中 */
	align-items: flex-start;
	min-height: 100vh;
	padding-top: 50px;
	background-color: #f8f9fa;
}

table {
	width: 80%;
	text-align: center; /* 文字預設置中 */
}

.amount {
	text-align: right; /* 金額靠右 */
}

.cart-actions form {
	display: inline-block;
	margin: 0;
}
</style>
</head>
<body>
	<div>
		<div class="container mt-3">
			<div th:if="${message}" id="flashMessageSuccess" class="alert alert-success"
				role="alert">
				<span th:text="${message}"></span>
			</div>
			<div th:if="${error}" id="flashMessageError" class="alert alert-danger"
				role="alert">
				<span th:text="${error}"></span>
			</div>
		</div>

		<h1 class="text-center mb-4">我的購物車</h1>
		<!-- 結帳用的 form 放在 table 外 -->
		<form id="orderForm" th:action="@{/orders/create}" method="post"></form>

		<table class="table table-bordered table-striped">
			<thead>
				<tr>
					<th>選取</th>
					<th>商品名稱</th>
					<th>單價</th>
					<th>數量</th>
					<th>小計</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="item : ${cart.items}">
					<td><input type="checkbox" name="selectedProducts"
						th:value="${item.product.id}" form="orderForm"></td>
					<td th:text="${item.product.name}"></td>
					<td class="amount"
						th:text="${'NT$ ' + #numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}"></td>

					<!-- 將 form 放在 td 內 -->
					<td>
						<form th:action="@{/cart/update}" method="post" class="d-inline">
							<input type="hidden" name="productId"
								th:value="${item.product.id}"> <input type="number"
								name="quantity" th:attr="max=${item.product.stock}" min="1"
								th:value="${item.quantity}" onchange="this.form.submit()">
						</form>
					</td>
					<td class="amount"
						th:text="${'NT$ ' + #numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')}"></td>
					<!-- 刪除按鈕 -->
					<td>
						<form th:action="@{/cart/remove}" method="post">
							<input type="hidden" name="productId"
								th:value="${item.product.id}">
							<button type="submit" class="btn btn-sm btn-danger">刪除</button>
						</form>
					</td>
				</tr>

			</tbody>
		</table>

		<h3 class="text-end">
			總價: <span class="amount"
				th:text="${'NT$ ' + #numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')}">0</span>
		</h3>


		<div class="text-center mt-3">
			<p th:if="${isEmpty}" class="text-muted mt-2">購物車目前沒有商品，無法結帳。</p>
		</div>
		<!-- 結帳按鈕掛到外部 form -->

		<div class="text-center mt-3 d-flex justify-content-center gap-2">
			<!-- 結帳按鈕掛到外部 form -->
			<button type="submit" form="orderForm" class="btn btn-success"
        th:disabled="${isEmpty}">結帳並建立訂單</button>


			<!-- 返回商品列表按鈕 -->
			<form th:action="@{/products}" method="get" class="m-0">
				<button class="btn btn-primary" type="submit">返回商品列表</button>
			</form>
		</div>

	</div>

	<script th:src="@{/resources/js/flashMessage.js}"></script>
</body>
</html>
